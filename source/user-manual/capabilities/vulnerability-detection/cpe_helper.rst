.. Copyright (C) 2018 Wazuh, Inc.

.. _vu_cpe_helper:

CPE Helper
==========

Since Wazuh 3.10.0, Vulnerability Detector integrates with the National Vulnerability Database to analyze vulnerabilities on Windows agents. In a future release this integration will be extended to the rest of systems.

Syscollector send the packages and versions of the agents, which is indexed in Wazuh DB and used by Vulnerability Detector directly. This information was contrasted directly against vulnerability feeds, generating alerts if vulnerabilities are detected. However, program names submitted by Syscollector from Windows agents is not valid to look for vulnerabilities in the feed of the National Vulnerability Database.

For this reason, we created an auxiliary dictionary that could convert the software inventory of Windows agents to the standard used by this provider: `CPE (Common Platform Enumeration) <https://nvd.nist.gov/products/cpe>`_.

- `CPE Helper Schema`_
- `Dictionary schema`_
- `Translation types`_
- `How to translate a Windows program to CPE format`_

CPE Helper Schema
-----------------

The CPE helper has the following fields:

- **version**: Version of the CPE helper.
- **version_format**: Version of the CPE helper format. If it change the major, you will need to upgrade Wazuh to the latest version to process it.
- **update_date**: Date the dictionary was last updated.
- **dictionary**: Dictionary containing the translation entries.

  .. code-block:: json

    {
        "version": "1.0",
        "version_format": "1.0",
        "update_date": "2019-05-14T00:00Z",
        "dictionary": [
            "..."
        ]
    }

Dictionary schema
-----------------

Each dictionary entry has the following fields:

- **target**: Operating system affected by this entry. At the moment, only Windows is available.

- **source**: Parameters of the program to be translated. Allowed sections:

  - **vendor**: Array of one or more *vendor* fields that can match this entry. You can use ``%`` to autocomplete. Example: *Microsoft Corporation%*.
  - **product**: Array of one or more *product* fields that can match this entry. You can use ``%`` to autocomplete. Example *Google Chrome%*.
  - **version (optional)**: Array of one or more *version* fields that can match this entry. You can use ``%`` to autocomplete. Example *11.%*.

- **translation**: Section to specify the CPE translation. Allowed sections:

  - **vendor**: Array of one or more *vendor* fields that can form the SSC of the input program.
  - **product**: Array of one or more *product* fields that can form the SSC of the input program.
  - **version (optional)**: Array of one or more *version* fields that can form the CPE of the input program.
  - **sw_edition (optional)**: Array of one or more *sw_edition* fields that can form the SSC of the input program.
  - **msb_name (optional)**: For Microsoft products, the name of the programs in the `Microsoft Security Guide <https://portal.msrc.microsoft.com/en-us/security-guidance>`_.

- **action**: Array of actions to apply on the entry.

  .. code-block:: json

      {
          "target": "target OS",
          "source": {
              "vendor": [
                  "..."
              ],
              "product": [
                  "..."
              ],
              "version": [
                  "..."
              ]
          },
          "translation": {
              "vendor": [
                  "..."
              ],
              "product": [
                  "..."
              ],
              "version": [
                  "..."
              ],
              "sw_edition": [
                  "..."
              ],
              "msb_name": [
                  "..."
              ]
          },
          "action": [
              "..."
          ]
      }

Translation types
-----------------

The conversion of the program to CPE format will be done according to the flags used in the action section. These are:

+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Option                                   | Description                                                                                                                                                                                                                                                       |
+==========================================+===================================================================================================================================================================================================================================================================+
| **ignore**                               | Ignora la entrada del diccionario.                                                                                                                                                                                                                                |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_vendor**                       | Convert the vendor to the indicated one if the pattern matches.                                                                                                                                                                                                   |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_product**                      | Converts the product to the indicated one if the pattern matches.                                                                                                                                                                                                 |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_vendor_if_match**              | Used when there is more than one vendor at the same dictionary entry, it uses the vendor parallel to the one that matches the pattern.                                                                                                                            |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_product_if_match**             | Used when there is more than one product at the same dictionary entry, it uses the product parallel to the one that matches the pattern.                                                                                                                          |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_version_if_match**             | Used when there is more than one version at the same dictionary entry, it uses the version parallel to the one that matches the pattern.                                                                                                                          |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_sw_edition_if_product_match**  | Used with the sections ``sw_edition`` and ``version``, it uses the *sw_edition* field parallel to the matching version.                                                                                                                                           |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **check_hotfix**                         | Usado para indicar aquellos productos software donde no se sepa el rango de vulnerabilidad y necesiten validar un hotfix. Suelen ser los productos de Microsoft.                                                                                                  |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_msb_name_if_version_match**    | Used with the sections ``msb_name`` and ``version``, it indicates the name taken by the program in the `Microsoft Security Guide <https://portal.msrc.microsoft.com/en-us/security-guidance>`_. It needs to be used with ``check_hotfix`` and Microsoft products. |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


How to translate a Windows program to CPE format
------------------------------------------------

To include a Windows program in the CPE Helper dictionary, in order to be able to look for vulnerabilities for it, it is necessary to
know the vendor, name of product and version that Syscollector extracts from the registry. After this, it is necessary to look for
the CPE that better adapts to this program to end up configuring the diccionary entry with the opportune actions.


 1. Get the agent's programs.

  The programs installed in the agent can be consulted from the API with the following call:

  .. code-block:: console

    curl -u foo:bar -k -X GET "https://127.0.0.1:55000/syscollector/001/packages?pretty&offset=10&sort=-name"

  In this case use case we are going to make the translation to CPE of the next node:

  .. code-block:: json

    {
       "scan": {
          "id": 27266015,
          "time": "2019/05/21 16:25:21"
       },
       "version": "2.4.5",
       "name": "Wireshark 2.4.5 64-bit",
       "format": "win",
       "vendor": "The Wireshark developer community, https://www.wireshark.org",
       "location": "C:\\Program Files\\Wireshark",
       "architecture": "i686"
    }

 2. Find the CPE program.

  To find the CPE to which the program is translated, we can use the `NVD's CPEs search engine <https://nvd.nist.gov/products/cpe/search>`_.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-wireshark1.png
      :title: Wireshark CPE search
      :align: center
      :width: 100%


  We select the least generic CPE. In this case, we will take the first one.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-wireshark2.png
      :title: Wireshark CPE election
      :align: center
      :width: 100%


  We are interested only in the fields *vendor* and *product* of this CPE, since the version that comes from Syscollector is valid.
  We can find out by checking if it follows the same format as the CPEs we found (2.4.5 ~= 0.99.2).


  We are going to replace a vendor and a product, so we only need to use the ``replace_vendor``
  and ``replace_product`` actions. The rule we are going to use is:

  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+
  | CPE part     | Syscollector name                                            | Source pattern          | Translation      | Action           |
  +==============+==============================================================+=========================+==================+==================+
  | Vendor       | The Wireshark developer community, https://www.wireshark.org | %www.wireshark.org%     | wireshark        | replace_vendor   |
  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+
  | Product name | Wireshark 2.4.5 64-bit                                       | %wireshark%             | wireshark        | replace_product  |
  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+

  Finally, the resulting dictionary entry:

  .. code-block:: json

    {
        "target": "windows",
        "source": {
            "vendor": [
                "%www.wireshark.org%"
            ],
            "product": [
                "%wireshark%"
            ],
            "version": []
        },
        "translation": {
            "vendor": [
                "wireshark"
            ],
            "product": [
                "wireshark"
            ],
            "version": []
        },
        "action": [
            "replace_vendor",
            "replace_product"
        ]
    }
