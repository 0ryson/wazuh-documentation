.. Copyright (C) 2018 Wazuh, Inc.

.. _vu_cpe_helper:

CPE Helper
==========

Since Wazuh 3.10.0, Vulnerability Detector integrates with the National Vulnerability Database to analyze vulnerabilities on Windows agents. In a future release this integration will be extended to the rest of systems.

Syscollector send the packages and versions of the agents, which is indexed in Wazuh DB and used by Vulnerability Detector directly. This information was contrasted directly against vulnerability feeds, generating alerts if vulnerabilities are detected. However, program names submitted by Syscollector from Windows agents is not valid to look for vulnerabilities in the feed of the National Vulnerability Database.

For this reason, we created an auxiliary dictionary that could convert the software inventory of Windows agents to the standard used by this provider: `CPE (Common Platform Enumeration) <https://nvd.nist.gov/products/cpe>`_.

- `CPE Helper Schema`_
- `Dictionary schema`_
- `Translation types`_
- `How to translate a Windows program to CPE format`_
- `Combine several programs in a dictionary entry`_
- `Products whose version does not change between updates`_

CPE Helper Schema
-----------------

The CPE helper has the following fields:

- **version**: Version of the CPE helper.
- **version_format**: Version of the CPE helper format. If it change the major, you will need to upgrade Wazuh to the latest version to process it.
- **update_date**: Date the dictionary was last updated.
- **dictionary**: Dictionary containing the translation entries.

  .. code-block:: json

    {
        "version": "1.0",
        "version_format": "1.0",
        "update_date": "2019-05-14T00:00Z",
        "dictionary": [
            "..."
        ]
    }

Dictionary schema
-----------------

Each dictionary entry has the following fields:

- **target**: Operating system affected by this entry. At the moment, only Windows is available.

- **source**: Parameters of the program to be translated. Allowed sections:

  - **vendor**: Array of one or more *vendor* fields that can match this entry. You can use ``%`` to autocomplete. Example: *Microsoft Corporation%*.
  - **product**: Array of one or more *product* fields that can match this entry. You can use ``%`` to autocomplete. Example *Google Chrome%*.
  - **version (optional)**: Array of one or more *version* fields that can match this entry. You can use ``%`` to autocomplete. Example *11.%*.

- **translation**: Section to specify the CPE translation. Allowed sections:

  - **vendor**: Array of one or more *vendor* fields that can form the SSC of the input program.
  - **product**: Array of one or more *product* fields that can form the SSC of the input program.
  - **version (optional)**: Array of one or more *version* fields that can form the CPE of the input program.
  - **sw_edition (optional)**: Array of one or more *sw_edition* fields that can form the SSC of the input program.
  - **msb_name (optional)**: For Microsoft products, the name of the programs in the `Microsoft Security Guide <https://portal.msrc.microsoft.com/en-us/security-guidance>`_.

- **action**: Array of actions to apply on the entry.

  .. code-block:: json

      {
          "target": "target OS",
          "source": {
              "vendor": [
                  "..."
              ],
              "product": [
                  "..."
              ],
              "version": [
                  "..."
              ]
          },
          "translation": {
              "vendor": [
                  "..."
              ],
              "product": [
                  "..."
              ],
              "version": [
                  "..."
              ],
              "sw_edition": [
                  "..."
              ],
              "msb_name": [
                  "..."
              ]
          },
          "action": [
              "..."
          ]
      }

Translation types
-----------------

The conversion of the program to CPE format will be done according to the flags used in the action section. These are:

+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Option                                   | Description                                                                                                                                                                                                                                                       |
+==========================================+===================================================================================================================================================================================================================================================================+
| **ignore**                               | Ignore the dictionary entry.                                                                                                                                                                                                                                      |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_vendor**                       | Convert the vendor to the indicated one if the pattern matches.                                                                                                                                                                                                   |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_product**                      | Convert the product to the indicated one if the pattern matches.                                                                                                                                                                                                  |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_vendor_if_match**              | Used when there is more than one vendor at the same dictionary entry, it uses the vendor parallel to the one that matches the pattern.                                                                                                                            |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_product_if_match**             | Used when there is more than one product at the same dictionary entry, it uses the product parallel to the one that matches the pattern.                                                                                                                          |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_version_if_match**             | Used when there is more than one version at the same dictionary entry, it uses the version parallel to the one that matches the pattern.                                                                                                                          |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_sw_edition_if_product_match**  | Used with the sections ``sw_edition`` and ``version``, it uses the *sw_edition* field parallel to the matching version.                                                                                                                                           |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **check_hotfix**                         | Used to indicate those software products where the vulnerability range is not known and need to validate a hotfix. These are usually Microsoft products.                                                                                                          |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **replace_msb_name_if_version_match**    | Used with the sections ``msb_name`` and ``version``, it indicates the name taken by the program in the `Microsoft Security Guide <https://portal.msrc.microsoft.com/en-us/security-guidance>`_. It needs to be used with ``check_hotfix`` and Microsoft products. |
+------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


How to translate a Windows program to CPE format
------------------------------------------------

To include a Windows program in the CPE Helper dictionary, in order to be able to look for vulnerabilities for it, it is necessary to
know the vendor, name of product and version that Syscollector extracts from the registry. After this, it is necessary to look for
the CPE that better adapts to this program to end up configuring the diccionary entry with the opportune actions.

 1. Get the agent's programs.

  The programs installed in the agent can be consulted from the API with the following call:

  .. code-block:: console

    curl -u foo:bar -k -X GET "https://127.0.0.1:55000/syscollector/001/packages?pretty&offset=10&sort=-name"

  In this case use case we are going to make the translation to CPE of the next node:

  .. code-block:: json

    {
       "scan": {
          "id": 27266015,
          "time": "2019/05/21 16:25:21"
       },
       "version": "2.4.5",
       "name": "Wireshark 2.4.5 64-bit",
       "format": "win",
       "vendor": "The Wireshark developer community, https://www.wireshark.org",
       "location": "C:\\Program Files\\Wireshark",
       "architecture": "i686"
    }

 2. Find the CPE program.

  To find the CPE to which the program is translated, we can use the `NVD's CPEs search engine <https://nvd.nist.gov/products/cpe/search>`_.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-wireshark1.png
      :title: Wireshark CPE search
      :align: center
      :width: 100%


  We select the least generic CPE. In this case, we will take the first one.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-wireshark2.png
      :title: Wireshark CPE election
      :align: center
      :width: 100%


  We are interested only in the fields *vendor* and *product* of this CPE, since the version that comes from Syscollector is valid.
  We can find out by checking if it follows the same format as the CPEs we found (2.4.5 ~= 0.99.2).


  The entry only has to replace a vendor and a product, so we only need to use the ``replace_vendor``
  and ``replace_product`` actions. The rule we are going to use is:

  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+
  | CPE part     | Syscollector name                                            | Source pattern          | Translation      | Action           |
  +==============+==============================================================+=========================+==================+==================+
  | Vendor       | The Wireshark developer community, https://www.wireshark.org | %www.wireshark.org%     | wireshark        | replace_vendor   |
  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+
  | Product name | Wireshark 2.4.5 64-bit                                       | %wireshark%             | wireshark        | replace_product  |
  +--------------+--------------------------------------------------------------+-------------------------+------------------+------------------+

  Finally, the resulting dictionary entry:

  .. code-block:: json

    {
        "target": "windows",
        "source": {
            "vendor": [
                "%www.wireshark.org%"
            ],
            "product": [
                "%wireshark%"
            ],
            "version": []
        },
        "translation": {
            "vendor": [
                "wireshark"
            ],
            "product": [
                "wireshark"
            ],
            "version": []
        },
        "action": [
            "replace_vendor",
            "replace_product"
        ]
    }

Combine several programs in a dictionary entry
----------------------------------------------

A software product can have several CPEs associated depending on its vendor, version, or the syntax with which its name was defined.
This section will explain how to create an entry to include all possible translations of a program collected by Syscollector.

For the guide, the generation of the dictionary entry for Skype and Skype for Business will be used as use case.

 1. Get the agent's programs.

  The programs installed in the agent can be consulted from the API with the following call:

  .. code-block:: console

    curl -u foo:bar -k -X GET "https://127.0.0.1:55000/syscollector/001/packages?pretty&offset=10&sort=-name"

  If we have *Skype* and *Skype for Business* installed, we will get 2 nodes as follows:

  .. code-block:: json

    {
     "scan": {
        "id": 908227078,
        "time": "2019/05/22 10:05:24"
     },
     "format": "win",
     "version": "16.0.11425.20244",
     "location": "C:\\Program Files (x86)\\Microsoft Office",
     "name": "Skype for Business Basic 2016 - en-us",
     "vendor": "Microsoft Corporation",
     "architecture": "x86_64"
    }
    {
     "scan": {
        "id": 908227078,
        "time": "2019/05/22 10:05:24"
     },
     "format": "win",
     "version": "8.42",
     "install_time": "20190329",
     "location": "C:\\Program Files (x86)\\Microsoft\\Skype for Desktop\\",
     "name": "Skype version 8.42",
     "vendor": "Skype Technologies S.A.",
     "architecture": "i686"
    }

 2. Find the CPE program.

  To find the CPE to which the program is translated, we can use the `NVD's CPEs search engine <https://nvd.nist.gov/products/cpe/search>`_.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-skype1.png
      :title: Skype CPE search
      :align: center
      :width: 100%

  We can observe various combinations of *vendor* and *product* fields for the products we are looking for. *Skype for Business
  Server* is not included in this use case, but it could be included in the same way.

  .. thumbnail:: ../../../images/manual/vuln-detector/cpe-search-skype2.png
      :title: Skype CPE election
      :align: center
      :width: 100%

  Again, we are interested only in the fields *vendor* and *product* of this CPE, since the
  version that comes from Syscollector seems valid.  We can find out by checking if it follows
  the same format as the CPEs we found (8.42 ~= 8.35).

  The entry will have to replace the vendor and the product between 2 combinations each, so we will use the actions ``replace_vendor_if_match``
  and ``replace_product_if_match``. The rule we are going to use is:

  +--------------+--------------------------------------------------------------+-------------------------+-----------------------+---------------------------+
  | CPE part     | Syscollector name                                            | Source pattern          | Translation           | Action                    |
  +==============+==============================================================+=========================+=======================+===========================+
  | Vendor       | Microsoft Corporation                                        | Microsoft%              | microsoft             | replace_vendor_if_match   |
  |              +--------------------------------------------------------------+-------------------------+-----------------------+                           |
  |              | Skype Technologies S.A.                                      | Skype%                  | skype                 |                           |
  +--------------+--------------------------------------------------------------+-------------------------+-----------------------+---------------------------+
  | Product name | Skype for Business Basic 2016 - en-us                        | Skype for Business%     | skype_for_business    | replace_product_if_match  |
  |              +--------------------------------------------------------------+-------------------------+-----------------------+                           |
  |              | Skype version 8.42                                           | Skype%                  | skype                 |                           |
  +--------------+--------------------------------------------------------------+-------------------------+-----------------------+---------------------------+

  Finally, the resulting dictionary entry:

  .. code-block:: json

    {
        "target": "windows",
        "source": {
            "vendor": [
                "Skype%",
                "Microsoft%"
            ],
            "product": [
                "Skype for Business%",
                "Skype%"
            ],
            "version": []
        },
        "translation": {
            "vendor": [
                "skype",
                "microsoft"
            ],
            "product": [
                "skype_for_business",
                "skype"
            ],
            "version": []
        },
        "action": [
            "replace_vendor_if_match",
            "replace_product_if_match"
        ]
    }

.. note :: The product **Skype for Business Basic 2016 - en-us** matches the ``Skype for Business%`` and ``Skype%`` patterns,
          but will use the first one because they are sorted by priority.

Products whose version does not change between updates
------------------------------------------------------

There are some software products, generally from Microsoft, whose vulnerabilities we cannot confirm
by consulting the National Vulnerability Database. These products do not change their visible version
between updates, so we cannot know when they are no longer vulnerable.

For example, if we consult the *CVE-2019-0671* vulnerability for *Microsof Office 2016* in the `National
Vulnerability Database <https://nvd.nist.gov/vuln/detail/CVE-2019-0671>`_, we will find the following.

.. thumbnail:: ../../../images/manual/vuln-detector/nvd-vulnerability.png
    :title: Affected software for CVE-2019-0671
    :align: center
    :width: 100%

As we can see, the CPEs only specify that the vulnerability affects the 2016 version, which is not enough because
our program may not be affected by the vulnerability if the patch that fixes it has been applied.

In this case, we should check the Microsoft Security Update Guide to verify if *Microsoft Office 2016*
fix the vulnerability in any update.

.. thumbnail:: ../../../images/manual/vuln-detector/microsoft-sug.png
    :title: CVE-2019-0671 in the Microsoft Security Update Guide
    :align: center
    :width: 100%

Vulnerability Detector can automate this search using the CPE Helper and the ``check_hotfix`` action.
To illustrate the process, we will follow the same procedure as in the previous use cases.


 1. Get the agent's programs.

  The programs installed in the agent can be consulted from the API with the following call:

  .. code-block:: console

    curl -u foo:bar -k -X GET "https://127.0.0.1:55000/syscollector/001/packages?pretty&offset=10&sort=-name"

  If we have *Microsoft Office 2016* and *Office 16 Click-to-Run* installed, we will get 2 nodes as follows:

  .. code-block:: json

    {
       "scan": {
          "id": 214307089,
          "time": "2019/05/22 11:53:07"
       },
       "vendor": "Microsoft Corporation",
       "name": "Office 16 Click-to-Run Extensibility Component 64-bit Registration",
       "install_time": "20190429",
       "architecture": "x86_64",
       "format": "win",
       "version": "16.0.11425.20244"
    }
    {
        "scan": {
           "id": 214307089,
           "time": "2019/05/22 11:53:07"
        },
        "version": "16.0.11425.20244",
        "location": "C:\\Program Files (x86)\\Microsoft Office",
        "vendor": "Microsoft Corporation",
        "architecture": "x86_64",
        "format": "win",
        "name": "Microsoft Office Professional Plus 2016 - en-us"
     }

 2. Find the CPE program.

  To extract the CPEs from the program, we can use the information previously consulted
  on the CPEs affected by *CVE-2019-0671*. From that source we can see exactly which CPEs
  are checked to confirm vulnerability. These are:

  - cpe:2.3:a:microsoft:office:2016:*:*:*:*:*:*:*
  - cpe:2.3:a:microsoft:office:2016:*:*:*:click-to-run:*:*:*

  We can see that the 2 target programs only differ in the field *sw_edition* (click-to-run). Therefore,
  we will use the action ``replace_sw_edition_if_product_match``, which will help us to set this CPE field
  if we detect *Office 16 Click-to-Run* in the program name, and the ``sw_edition`` section.

  We also have to take into account that the Syscollector version is not valid for this use case and we
  need to transform it from 16 to 2016 to create the CPE. If we want to contemplate more versions of
  Microsoft Office, we must use the action ``replace_version_if_match`` with the corresponding equivalences.

  Finally, we will indicate the name of these programs in the Microsoft Security Update Guide using
  their version as a reference. To do this, use the ``replace_msb_name_if_version_match`` action and
  the ``msb_name`` section. Do not forget that to perform an evaluation through the hotfixes installed on a
  Windows computer we must also include the action ``check_hotfixes``.


  +--------------+----------------------------------------------------------------------+-------------------------------------------------+--------------------------------------+--------------------------------------+
  | CPE part     | Syscollector name                                                    | Source pattern                                  | Translation                          | Action                               |
  +==============+======================================================================+=================================================+======================================+======================================+
  | Vendor       | Microsoft Corporation                                                | Microsoft Corporation                           | microsoft                            | replace_vendor                       |
  +--------------+----------------------------------------------------------------------+-------------------------------------------------+--------------------------------------+--------------------------------------+
  | Product name | Microsoft Office Professional Plus 2016 - en-us                      | Microsoft Office%                               | office                               | replace_product                      |
  |              +----------------------------------------------------------------------+-------------------------------------------------+                                      |                                      |
  |              | Office 16 Click-to-Run Extensibility Component 64-bit Registration   | Office % Click-to-Run Extensibility Component%  |                                      |                                      |
  |              |                                                                      |                                                 +--------------------------------------+--------------------------------------+
  |              |                                                                      |                                                 | click-to-run **(sw_edition)**        | replace_sw_edition_if_product_match  |
  +--------------+----------------------------------------------------------------------+-------------------------------------------------+--------------------------------------+--------------------------------------+
  | Version      | 16.0.11425.20244                                                     | 16.%                                            | 2016                                 | replace_version_if_match             |
  |              |                                                                      |                                                 +--------------------------------------+--------------------------------------+
  |              |                                                                      |                                                 | Microsoft Office 2016 **(msb_name)** | replace_msb_name_if_version_match    |
  +--------------+----------------------------------------------------------------------+-------------------------------------------------+--------------------------------------+--------------------------------------+

  The resulting dictionary entry, including more versions of *Microsoft Office*:

  .. code-block:: json

    {
      "target": "windows",
      "source": {
          "vendor": [
              "Microsoft Corporation"
          ],
          "product": [
              "Microsoft Office%",
              "Office % Click-to-Run Extensibility Component%"
          ],
          "version": [
              "11.%",
              "12.%",
              "14.%",
              "15.%",
              "16.%"
          ]
      },
      "translation": {
          "vendor": [
              "microsoft"
          ],
          "product": [
              "office"
          ],
          "version": [
              "2003",
              "2007",
              "2010",
              "2013",
              "2016"
          ],
          "sw_edition": [
              "",
              "click-to-run"
          ],
          "msb_name": [
              "Microsoft Office 2003",
              "Microsoft Office 2007",
              "Microsoft Office 2010",
              "Microsoft Office 2013",
              "Microsoft Office 2016"
          ]
      },
      "action": [
          "replace_vendor",
          "replace_product",
          "replace_version_if_match",
          "replace_sw_edition_if_product_match",
          "replace_msb_name_if_version_match",
          "check_hotfix"
      ]
    }

  Alert example using this dictionary entry:

  .. code-block:: json

    {
        "vulnerability":{
            "cve":"CVE-2019-0671",
            "title":"A remote code execution vulnerability exists when the Microsoft Office Access Connectivity Engine improperly handles objects in memory, aka 'Microsoft Office Access Connectivity Engine Remote Code Execution Vulnerability'. This CVE ID is unique from CVE-2019-0672, CVE-2019-0673, CVE-2019-0674, CVE-2019-0675.",
            "severity":"High",
            "published":"2019-03-05T23:29Z",
            "updated":"2019-03-06T15:53Z",
            "state":"Fixed",
            "cvss":{
                "cvss2":{
                    "vector":{
                        "attack_vector":"network",
                        "access_complexity":"medium ",
                        "authentication":"none",
                        "integrity_impact":"complete",
                        "availability":"complete"
                    },
                    "base_score":"9.300000"
                },
                "cvss3":{
                    "vector":{
                        "attack_vector":"local",
                        "access_complexity":"low",
                        "confidentiality_impact":"low",
                        "availability":"high",
                        "privileges_required":"none",
                        "user_interaction":"required ",
                        "scope":"unchanged"
                    },
                    "base_score":"7.800000"
                }
            },
            "software":{
                "name":"Microsoft Office Professional Plus 2016 - en-us",
                "version":"16.0.11425.20244",
                "generated_cpe":"a:microsoft:office:2016::::::x86_64:",
                "architecture":"x86_64"
            },
            "condition":"4018294 patch is not installed.",
            "cwe_reference":"CWE-119",
            "reference":"http://www.securityfocus.com/bid/106928"
        }
    }
