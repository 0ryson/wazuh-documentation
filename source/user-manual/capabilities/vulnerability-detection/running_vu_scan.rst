.. Copyright (C) 2019 Wazuh, Inc.

.. _running_vu_scan:

Running a vulnerability scan
============================

The following example shows how to configure the necessary components to run the vulnerability detection process.

1. Enable the agent module used to collect installed packages on the monitored system.

  You can do this adding the following block of settings to your shared agent configuration file:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
    </wodle>

  If you want to scan vulnerabilities in Windows agents, you will also have to add the ``os`` scan:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
      <os>yes</os>
    </wodle>

 Check :doc:`Syscollector settings<../../reference/ossec-conf/wodle-syscollector>` for more details.

2. Enable the manager module used to detect vulnerabilities.

  You can do this adding a block like the following to your manager configuration file:

  .. code-block:: xml

    <wodle name="vulnerability-detector">
      <disabled>no</disabled>
      <interval>5m</interval>
      <run_on_start>yes</run_on_start>
      <provider name="canonical">
        <disabled>no</disabled>
        <os>bionic</os>
        <update_interval>1h</update_interval>
      </provider>
    </wodle>

  Remember to restart the manager to apply the changes:

  a. For Systemd:

    .. code-block:: console

      # systemctl restart wazuh-manager

  b. For SysV Init:

    .. code-block:: console

      # service wazuh-manager restart

Check :doc:`Vulnerability detector settings<../../reference/ossec-conf/wodle-vuln-detector>` for more details.

The following fields are captured in every alert:

- **CVE**: The Common Vulnerabilities and Exposures identifier for the corresponding vulnerability.
- **Title**: Short description of the impact of vulnerability.
- **Severity**: It specifies the impact of the vulnerability in terms of security.
- **Published**: Date when the vulnerability was included in the official database.
- **Reference**: URL of the official database website with extra information of the vulnerability.
- **Rationale**: Broad description of the vulnerability.
- **State**: This field informs if it exists a patch for the vulnerability (*fixed*) or instead, its state.
- **CVSS**: The Common Vulnerability Score System in version 2 and 3.
- **Condition**: Reason for report the vulnerability.
- **CWE**: The Common Weakness Enumeration reference.

See below for examples of alerts:

.. code-block:: console
    :emphasize-lines: 3,6

    ** Alert 1532935655.161547: - vulnerability-detector,gdpr_IV_35.7.d,
    2018 Jul 30 09:27:35 manager->vulnerability-detector
    Rule: 23505 (level 10) -> 'CVE-2018-3693 on Ubuntu 18.04 LTS (bionic) - high.'
    vulnerability.cve: CVE-2018-3693
    vulnerability.title: CVE-2018-3693 on Ubuntu 18.04 LTS (bionic) - high.
    vulnerability.severity: High
    vulnerability.published: 2018-07-10
    vulnerability.updated: 2018-07-10
    vulnerability.reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-3693
    vulnerability.state: Pending confirmation
    vulnerability.software.name: firefox
    vulnerability.software.version: 61.0.1+build1-0ubuntu0.18.04.1
    vulnerability.software.architecture: i686

.. code-block:: console
    :emphasize-lines: 3,5

    ** Alert 1562945207.7314: - vulnerability-detector,gdpr_IV_35.7.d,
    2019 Jul 12 15:26:47 (agcent7) 10.0.2.15->vulnerability-detector
    Rule: 23504 (level 7) -> 'python: failure to validate certificates in the HTTP client with TLS (PEP 476)'
    {"vulnerability":{"cve":"CVE-2014-9365","title":"python: failure to validate certificates in the HTTP client with TLS (PEP 476)","severity":"Medium","published":"2014-12-11T00:00:00+00:00","state":"Fixed","cvss":{"cvss2":{"vector":{"attack_vector":"network","access_complexity":"medium ","authentication":"none","integrity_impact":"partial ","availability":"none"},"base_score":5.8},"cvss3":{"base_score":4.7}},"software":{"name":"python","version":"2.7.5-48.el7","architecture":"x86_64"},"condition":"Package less than 2.7.5-58.el7","advisories":"RHSA-2017:1868,RHSA-2017:1162","cwe_reference":"CWE-345","bugzilla_reference":"https://bugzilla.redhat.com/show_bug.cgi?id=1173041","reference":"https://access.redhat.com/security/cve/CVE-2014-9365"}}
    vulnerability.cve: CVE-2014-9365
    vulnerability.title: python: failure to validate certificates in the HTTP client with TLS (PEP 476)
    vulnerability.severity: Medium
    vulnerability.published: 2014-12-11T00:00:00+00:00
    vulnerability.state: Fixed
    vulnerability.cvss.cvss2.vector.attack_vector: network
    vulnerability.cvss.cvss2.vector.access_complexity: medium
    vulnerability.cvss.cvss2.vector.authentication: none
    vulnerability.cvss.cvss2.vector.integrity_impact: partial
    vulnerability.cvss.cvss2.vector.availability: none
    vulnerability.cvss.cvss2.base_score: 5.800000
    vulnerability.cvss.cvss3.base_score: 4.700000
    vulnerability.software.name: python
    vulnerability.software.version: 2.7.5-48.el7
    vulnerability.software.architecture: x86_64
    vulnerability.condition: Package less than 2.7.5-58.el7
    vulnerability.advisories: RHSA-2017:1868,RHSA-2017:1162
    vulnerability.cwe_reference: CWE-345
    vulnerability.bugzilla_reference: https://bugzilla.redhat.com/show_bug.cgi?id=1173041
    vulnerability.reference: https://access.redhat.com/security/cve/CVE-2014-9365


.. code-block:: console
    :emphasize-lines: 3,6

    ** Alert 1552410861.5364618: - vulnerability-detector,gdpr_IV_35.7.d,
    2019 Mar 12 17:14:21 (agwin-2016) 192.168.99.136->vulnerability-detector
    Rule: 23504 (level 7) -> 'Windows 7 SP1, Windows 8.1 and RT 8.1, Windows Server 2008 SP2 and R2 SP1, Windows Server 2012 and R2, Windows 10 Gold, 1511, 1607, 1703 and 1709, Windows Server 2016 and Windows Server, version 1709 allow a remote code execution vulnerability due to the way the Routing and Remote Access service handles requests, aka "Windows RRAS Service Remote Code Execution Vulnerability".'
    vulnerability.cve: CVE-2017-11885
    vulnerability.title: Windows 7 SP1, Windows 8.1 and RT 8.1, Windows Server 2008 SP2 and R2 SP1, Windows Server 2012 and R2, Windows 10 Gold, 1511, 1607, 1703 and 1709, Windows Server 2016 and Windows Server, version 1709 allow a remote code execution vulnerability due to the way the Routing and Remote Access service handles requests, aka "Windows RRAS Service Remote Code Execution Vulnerability".
    vulnerability.severity: Medium
    vulnerability.published: 2017-12-12T21:29Z
    vulnerability.updated: 2018-10-30T16:27Z
    vulnerability.state: Fixed
    vulnerability.cvss.cvss2.vector.attack_vector: network
    vulnerability.cvss.cvss2.vector.access_complexity: medium
    vulnerability.cvss.cvss2.vector.authentication: none
    vulnerability.cvss.cvss2.vector.integrity_impact: complete
    vulnerability.cvss.cvss2.vector.availability: complete
    vulnerability.cvss.cvss2.base_score: 9.300000
    vulnerability.cvss.cvss3.vector.attack_vector: local
    vulnerability.cvss.cvss3.vector.access_complexity: low
    vulnerability.cvss.cvss3.vector.confidentiality_impact: low
    vulnerability.cvss.cvss3.vector.availability: high
    vulnerability.cvss.cvss3.vector.privileges_required: none
    vulnerability.cvss.cvss3.vector.user_interaction: required
    vulnerability.cvss.cvss3.vector.scope: unchanged
    vulnerability.cvss.cvss3.base_score: 7.800000
    vulnerability.software.version: 16.0.11727.20230
    vulnerability.software.generated_cpe: a:microsoft:office:2016::::::x86_64:
    vulnerability.software.architecture: x86_64
    vulnerability.condition: 4053579 patch is not installed.
    vulnerability.cwe_reference: CWE-20
    vulnerability.reference: http://www.securityfocus.com/bid/102055


Here we can see an alert in Kibana:

.. thumbnail:: ../../../images/manual/vuln-detector/vuln-detector-kibana.png
    :title: Vulnerability detector alert example
    :align: center
    :width: 100%

One more example, this time in Splunk:

.. thumbnail:: ../../../images/manual/vuln-detector/vuln-detector-splunk.png
    :title: Vulnerability detector alert example
    :align: center
    :width: 100%
