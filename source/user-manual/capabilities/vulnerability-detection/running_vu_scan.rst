  .. Copyright (C) 2019 Wazuh, Inc.

.. _running_vu_scan:

Running a vulnerability scan
============================

The following example shows how to configure the necessary components to run the vulnerability detection process.

1. Enable the agent module used to collect installed packages on the monitored system.

  It can be done by adding the following block of settings to your shared agent configuration file:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
    </wodle>

  If you want to scan vulnerabilities in Windows agents, you will also have to add the ``os`` and ``hotfixes`` scans:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
      <os>yes</os>
      <hotfixes>yes</hotfixes>
    </wodle>

 These scans are enabled by default. For more information about the inventory module, check :doc:`Syscollector settings<../../reference/ossec-conf/wodle-syscollector>`.

2. Enable the manager module used to detect vulnerabilities.

  You can do this adding a block like the following to your manager configuration file:

  .. code-block:: xml

    <vulnerability-detector>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <run_on_start>yes</run_on_start>
      <provider name="canonical">
        <enabled>yes</enabled>
        <os>bionic</os>
        <update_interval>1h</update_interval>
      </provider>
      <provider name="nvd">
        <enabled>yes</enabled>
        <update_from_year>2010</update_from_year>
        <update_interval>1h</update_interval>
      </provider>
    </vulnerability-detector>

  Remember to restart the manager to apply the changes:

  a. For Systemd:

    .. code-block:: console

      # systemctl restart wazuh-manager

  b. For SysV Init:

    .. code-block:: console

      # service wazuh-manager restart

Check :doc:`Vulnerability detector settings<../../reference/ossec-conf/vuln-detector>` for more details.

The following fields are included in every alert:

- **CVE**: The Common Vulnerabilities and Exposures identifier for the corresponding vulnerability.
- **Title**: Short description of the impact of vulnerability.
- **Severity**: It specifies the impact of the vulnerability in terms of security.
- **Published**: Date when the vulnerability was included in the official database.
- **Updated**: Date of the last vulnerability update.
- **Package**: Information about the affected package.
- **alert_origin**: Who detected the vulnerability (NVD and/or Vendor feed).
- **Reference**: URL of the official database website with extra information on the vulnerability.
- **Rationale**: Broad description of the vulnerability. To avoid extra-data, this field only appears if no reference is included.
- **State**: This field informs if it exists a patch for the vulnerability (*fixed*) or instead, its state.
- **Condition**: Reason for reporting the vulnerability.
- **CWE**: The Common Weakness Enumeration reference.
- **Bugzilla reference**: Link to the reference of the vulnerability in Bugzilla.
- **CVSS**: Vulnerability assessment according to the Common Vulnerability Scoring System (versions 2 and 3).
- **Advisories**: Red Hat security advisories.

See below for examples of alerts:

.. code-block:: none
    :emphasize-lines: 5,10
    :class: output

    ** Alert 1590407651.24259355: - vulnerability-detector,gdpr_IV_35.7.d,pci_dss_11.2.1,pci_dss_11.2.3,tsc_CC7.1,tsc_CC7.2,
    2020 May 25 13:54:11 c31dd66f7e82->vulnerability-detector
    Rule: 23504 (level 7) -> 'CVE-2019-14980 affects libmagickcore-6.q16-3'
    {"vulnerability":{"package":{"name":"libmagickcore-6.q16-3","source":"imagemagick","version":"8:6.9.7.4+dfsg-16ubuntu6.8","architecture":"amd64","condition":"package is greater or equal than 6.0 and is less than 6.9.10-42"},"cvss":{"cvss2":{"vector":{"attack_vector":"network","access_complexity":"medium","authentication":"none","confidentiality_impact":"none","integrity_impact":"none","availability":"partial"},"base_score":4.3},"cvss3":{"vector":{"attack_vector":"network","access_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"unchanged","confidentiality_impact":"none","integrity_impact":"none","availability":"high"},"base_score":6.5}},"cve":"CVE-2019-14980","title":"In ImageMagick 7.x before 7.0.8-42 and 6.x before 6.9.10-42, there is a use after free vulnerability in the UnmapBlob function that allows an attacker to cause a denial of service by sending a crafted file.","severity":"Medium","alert_origin":"NVD feed","published":"2019-08-12","updated":"2019-11-15","state":"Fixed","cwe_reference":"CWE-416","references":["http://lists.opensuse.org/opensuse-security-announce/2019-11/msg00040.html","http://lists.opensuse.org/opensuse-security-announce/2019-11/msg00042.html","https://github.com/ImageMagick/ImageMagick/commit/c5d012a46ae22be9444326aa37969a3f75daa3ba","https://github.com/ImageMagick/ImageMagick/compare/7.0.8-41...7.0.8-42","https://github.com/ImageMagick/ImageMagick6/commit/614a257295bdcdeda347086761062ac7658b6830","https://github.com/ImageMagick/ImageMagick6/issues/43"],"assigner":"cve@mitre.org","cve_version":"4.0"}}
    vulnerability.package.name: libmagickcore-6.q16-3
    vulnerability.package.source: imagemagick
    vulnerability.package.version: 8:6.9.7.4+dfsg-16ubuntu6.8
    vulnerability.package.architecture: amd64
    vulnerability.package.condition: package is greater or equal than 6.0 and is less than 6.9.10-42
    vulnerability.cvss.cvss2.vector.attack_vector: network
    vulnerability.cvss.cvss2.vector.access_complexity: medium
    vulnerability.cvss.cvss2.vector.authentication: none
    vulnerability.cvss.cvss2.vector.confidentiality_impact: none
    vulnerability.cvss.cvss2.vector.integrity_impact: none
    vulnerability.cvss.cvss2.vector.availability: partial
    vulnerability.cvss.cvss2.base_score: 4.300000
    vulnerability.cvss.cvss3.vector.attack_vector: network
    vulnerability.cvss.cvss3.vector.access_complexity: low
    vulnerability.cvss.cvss3.vector.privileges_required: none
    vulnerability.cvss.cvss3.vector.user_interaction: required
    vulnerability.cvss.cvss3.vector.scope: unchanged
    vulnerability.cvss.cvss3.vector.confidentiality_impact: none
    vulnerability.cvss.cvss3.vector.integrity_impact: none
    vulnerability.cvss.cvss3.vector.availability: high
    vulnerability.cvss.cvss3.base_score: 6.500000
    vulnerability.cve: CVE-2019-14980
    vulnerability.title: In ImageMagick 7.x before 7.0.8-42 and 6.x before 6.9.10-42, there is a use after free vulnerability in the UnmapBlob function that allows an attacker to cause a denial of service by sending a crafted file.
    vulnerability.severity: Medium
    vulnerability.alert_origin: NVD feed
    vulnerability.published: 2019-08-12
    vulnerability.updated: 2019-11-15
    vulnerability.state: Fixed
    vulnerability.cwe_reference: CWE-416
    vulnerability.references: ["http://lists.opensuse.org/opensuse-security-announce/2019-11/msg00040.html", "http://lists.opensuse.org/opensuse-security-announce/2019-11/msg00042.html", "https://github.com/ImageMagick/ImageMagick/commit/c5d012a46ae22be9444326aa37969a3f75daa3ba", "https://github.com/ImageMagick/ImageMagick/compare/7.0.8-41...7.0.8-42", "https://github.com/ImageMagick/ImageMagick6/commit/614a257295bdcdeda347086761062ac7658b6830", "https://github.com/ImageMagick/ImageMagick6/issues/43"]
    vulnerability.assigner: cve@mitre.org
    vulnerability.cve_version: 4.0


.. code-block:: none
    :emphasize-lines: 5,10
    :class: output

    ** Alert 1590151579.5565027: - vulnerability-detector,gdpr_IV_35.7.d,pci_dss_11.2.1,pci_dss_11.2.3,
    2020 May 22 12:46:19 c31dd66f7e82->vulnerability-detector
    Rule: 23505 (level 10) -> 'CVE-2018-12886 affects gcc'
    {"vulnerability":{"package":{"name":"gcc","version":"4.8.5-39.el7","architecture":"x86_64","condition":"package is greater or equal than 4.1 and is less or equal than 8.0"},"cvss":{"cvss2":{"vector":{"attack_vector":"network","access_complexity":"medium","authentication":"none","confidentiality_impact":"partial","integrity_impact":"partial","availability":"partial"},"base_score":6.8},"cvss3":{"vector":{"attack_vector":"network","access_complexity":"high","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality_impact":"high","integrity_impact":"high","availability":"high"},"base_score":8.1}},"cve":"CVE-2018-12886","title":"stack_protect_prologue in cfgexpand.c and stack_protect_epilogue in function.c in GNU Compiler Collection (GCC) 4.1 through 8 (under certain circumstances) generate instruction sequences when targeting ARM targets that spill the address of the stack protector guard, which allows an attacker to bypass the protection of -fstack-protector, -fstack-protector-all, -fstack-protector-strong, and -fstack-protector-explicit against stack overflow by controlling what the stack canary is compared against.","severity":"High","alert_origin":"NVD feed","published":"2019-05-22","updated":"2019-05-23","state":"Fixed","cwe_reference":"CWE-119","references":["https://gcc.gnu.org/viewcvs/gcc/trunk/gcc/config/arm/arm-protos.h?revision=266379&view=markup","https://www.gnu.org/software/gcc/gcc-8/changes.html"],"assigner":"cve@mitre.org","cve_version":"4.0"}}
    vulnerability.package.name: gcc
    vulnerability.package.version: 4.8.5-39.el7
    vulnerability.package.architecture: x86_64
    vulnerability.package.condition: package is greater or equal than 4.1 and is less or equal than 8.0
    vulnerability.cvss.cvss2.vector.attack_vector: network
    vulnerability.cvss.cvss2.vector.access_complexity: medium
    vulnerability.cvss.cvss2.vector.authentication: none
    vulnerability.cvss.cvss2.vector.confidentiality_impact: partial
    vulnerability.cvss.cvss2.vector.integrity_impact: partial
    vulnerability.cvss.cvss2.vector.availability: partial
    vulnerability.cvss.cvss2.base_score: 6.800000
    vulnerability.cvss.cvss3.vector.attack_vector: network
    vulnerability.cvss.cvss3.vector.access_complexity: high
    vulnerability.cvss.cvss3.vector.privileges_required: none
    vulnerability.cvss.cvss3.vector.user_interaction: none
    vulnerability.cvss.cvss3.vector.scope: unchanged
    vulnerability.cvss.cvss3.vector.confidentiality_impact: high
    vulnerability.cvss.cvss3.vector.integrity_impact: high
    vulnerability.cvss.cvss3.vector.availability: high
    vulnerability.cvss.cvss3.base_score: 8.100000
    vulnerability.cve: CVE-2018-12886
    vulnerability.title: stack_protect_prologue in cfgexpand.c and stack_protect_epilogue in function.c in GNU Compiler Collection (GCC) 4.1 through 8 (under certain circumstances) generate instruction sequences when targeting ARM targets that spill the address of the stack protector guard, which allows an attacker to bypass the protection of -fstack-protector, -fstack-protector-all, -fstack-protector-strong, and -fstack-protector-explicit against stack overflow by controlling what the stack canary is compared against.
    vulnerability.severity: High
    vulnerability.alert_origin: NVD feed
    vulnerability.published: 2019-05-22
    vulnerability.updated: 2019-05-23
    vulnerability.state: Fixed
    vulnerability.cwe_reference: CWE-119
    vulnerability.references: ["https://gcc.gnu.org/viewcvs/gcc/trunk/gcc/config/arm/arm-protos.h?revision=266379&view=markup", "https://www.gnu.org/software/gcc/gcc-8/changes.html"]
    vulnerability.assigner: cve@mitre.org
    vulnerability.cve_version: 4.0


.. code-block:: none
    :emphasize-lines: 5,27
    :class: output

    ** Alert 1571138525.1311925: - vulnerability-detector,gdpr_IV_35.7.d,
    2019 Oct 15 11:22:05 (agwin) 172.16.210.128->vulnerability-detector
    Rule: 23504 (level 7) -> 'The Windows kernel in Windows Server 2008 SP2 and R2 SP1, and Windows 7 SP1 allows authenticated attackers to obtain sensitive information via a specially crafted document, aka "Windows Kernel Information Disclosure Vulnerability," a different vulnerability than CVE-2017-0220, CVE-2017-0258, and CVE-2017-0259.'
    {"vulnerability":{"cve":"CVE-2017-0175","title":"The Windows kernel in Windows Server 2008 SP2 and R2 SP1, and Windows 7 SP1 allows authenticated attackers to obtain sensitive information via a specially crafted document, aka \"Windows Kernel Information Disclosure Vulnerability,\" a different vulnerability than CVE-2017-0220, CVE-2017-0258, and CVE-2017-0259.","severity":"Medium","published":"2017-05-12","updated":"2018-10-30","state":"Fixed","cvss":{"cvss2":{"vector":{"attack_vector":"local","access_complexity":"low","authentication":"none","confidentiality_impact":"low","integrity_impact":"none","availability":"none"},"base_score":2.1},"cvss3":{"vector":{"attack_vector":"local","access_complexity":"high","confidentiality_impact":"high","integrity_impact":"none","availability":"none","privileges_required":"low","user_interaction":"none","scope":"unchanged"},"base_score":4.7}},"package":{"name":"Windows Server 2008 R2","generated_cpe":"o:microsoft:windows_server_2008:r2:sp1::::::"},"condition":"4019263 patch is not installed.","cwe_reference":"CWE-200","reference":"http://www.securityfocus.com/bid/98110"}}
    vulnerability.cve: CVE-2017-0175
    vulnerability.title: The Windows kernel in Windows Server 2008 SP2 and R2 SP1, and Windows 7 SP1 allows authenticated attackers to obtain sensitive information via a specially crafted document, aka "Windows Kernel Information Disclosure Vulnerability," a different vulnerability than CVE-2017-0220, CVE-2017-0258, and CVE-2017-0259.
    vulnerability.severity: Medium
    vulnerability.published: 2017-05-12
    vulnerability.updated: 2018-10-30
    vulnerability.state: Fixed
    vulnerability.cvss.cvss2.vector.attack_vector: local
    vulnerability.cvss.cvss2.vector.access_complexity: low
    vulnerability.cvss.cvss2.vector.authentication: none
    vulnerability.cvss.cvss2.vector.confidentiality_impact: low
    vulnerability.cvss.cvss2.vector.integrity_impact: none
    vulnerability.cvss.cvss2.vector.availability: none
    vulnerability.cvss.cvss2.base_score: 2.100000
    vulnerability.cvss.cvss3.vector.attack_vector: local
    vulnerability.cvss.cvss3.vector.access_complexity: high
    vulnerability.cvss.cvss3.vector.confidentiality_impact: high
    vulnerability.cvss.cvss3.vector.integrity_impact: none
    vulnerability.cvss.cvss3.vector.availability: none
    vulnerability.cvss.cvss3.vector.privileges_required: low
    vulnerability.cvss.cvss3.vector.user_interaction: none
    vulnerability.cvss.cvss3.vector.scope: unchanged
    vulnerability.cvss.cvss3.base_score: 4.700000
    vulnerability.package.name: Windows Server 2008 R2
    vulnerability.package.generated_cpe: o:microsoft:windows_server_2008:r2:sp1::::::
    vulnerability.package.condition: 4019263 patch is not installed.
    vulnerability.cwe_reference: CWE-200
    vulnerability.reference: http://www.securityfocus.com/bid/98110

Here we can see an alert in Kibana:

.. thumbnail:: ../../../images/manual/vuln-detector/vuln-detector-kibana.png
    :title: Vulnerability detector alert example
    :align: center
    :width: 100%

One more example, this time in Splunk:

.. thumbnail:: ../../../images/manual/vuln-detector/vuln-detector-splunk.png
    :title: Vulnerability detector alert example
    :align: center
    :width: 100%
