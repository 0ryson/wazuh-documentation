.. Copyright (C) 2018 Wazuh, Inc.

.. _vulnerability-detection:

Vulnerability detection
=======================

.. versionadded:: 3.2.0

This capability can be used to detect applications that are known to be vulnerable (affected by a CVE).

- `How it works`_
- `Compatibility matrix`_
- `Use case: Running a vulnerability scan`_

How it works
------------

To be able to detect vulnerabilities, now agents are able to natively collect a list of installed applications, sending it periodically to the manager (where it is stored in local sqlite databases, one per agent). In addition, the manager builds a global vulnerabilities database, using public CVE repositories, using it later to cross correlate this information with agent's applications inventory data.

The global vulnerabilities database is created automatically, currently pulling data from the following repositories:

- `<https://people.canonical.com>`_: Used to pull CVEs for Ubuntu Linux distributions.
- `<https://www.redhat.com>`_: Used to pull CVEs for Red Hat and CentOS Linux distributions.
- `<https://www.debian.com>`_: Used to pull CVEs for Debian Linux distributions.
- `<https://nvd.nist.gov/>`_: Used to pull CVEs from the National Vulnerability Database. Currently is only used to report Windows agents.

This database can be configured to be updated periodically, ensuring that the solution will check for the very latest CVEs.

Once the global vulnerabilty database (with the CVEs) is created, the detection process will look for vulnerable packages in the inventory databases (unique per agent). Alerts are generated when a CVE (Common Vulnerabilities and Exposures) affects a package that is known to be installed in one of the monitored servers.

Compatibility matrix
---------------------

The following table shows the operating systems that the vulnerability detector currently supports (we are working in supporting new ones) and the provider configuration needed for each distribution:

+---------------+------------------------+----------------------------------+
| Distribution  | Versions               | Configuration provider           |
+===============+========================+==================================+
|               | 5                      |                                  |
| Red Hat &     +------------------------+                                  |
| CentOS        | 6                      |                                  |
|               +------------------------+                                  |
|               | 7                      | Red Hat Security Data            |
+---------------+------------------------+                                  |
|               | 1                      |                                  |
| Amazon Linux  +------------------------+                                  |
|               | 2                      |                                  |
+---------------+------------------------+----------------------------------+
|               | precise / 12           |                                  |
|               +------------------------+                                  |
| Ubuntu        | trusty / 14            |                                  |
|               +------------------------+ Canonical                        |
|               | xenial / 16            |                                  |
|               +------------------------+                                  |
|               | bionic / 18            |                                  |
+---------------+------------------------+----------------------------------+
|               | wheezy / 7             |                                  |
|               +------------------------+                                  |
| Debian        | stretch / 8            | Debian                           |
|               +------------------------+                                  |
|               | jessie / 9             |                                  |
+---------------+------------------------+----------------------------------+
| Windows       | All supported versions | National Vulnerability Database  |
+---------------+------------------------+----------------------------------+

.. note:: The operating system support for a provider can be expanded using correctly the allow option.

Use case: Running a vulnerability scan
---------------------------------------

The following example shows how to configure the necessary components to run the vulnerability detection process.

1. Enable the agent module used to collect installed packages on the monitored system.

  You can do this adding the following block of settings to your shared agent configuration file:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
    </wodle>

  If you want to scan vulnerabilities in Windows agents, you will need to add the ``hotfixes`` and ``os`` scans:

  .. code-block:: xml

    <wodle name="syscollector">
      <disabled>no</disabled>
      <interval>1h</interval>
      <packages>yes</packages>
      <os>yes</os>
      <hotfixes>yes</hotfixes>
    </wodle>

 Check :doc:`Syscollector settings<../reference/ossec-conf/wodle-syscollector>` for more details.

2. Enable the manager module used to detect vulnerabilities.

  You can do this adding a block like the following to your manager configuration file:

  .. code-block:: xml

    <wodle name="vulnerability-detector">
      <disabled>no</disabled>
      <interval>5m</interval>
      <run_on_start>yes</run_on_start>
      <provider name="canonical">
        <disabled>no</disabled>
        <os>bionic</os>
        <update_interval>1h</update_interval>
      </provider>
    </wodle>

  Remember to restart the manager to apply the changes:

  a. For Systemd:

    .. code-block:: console

      # systemctl restart wazuh-manager

  b. For SysV Init:

    .. code-block:: console

      # service wazuh-manager restart

Check :doc:`Vulnerability detector settings<../reference/ossec-conf/wodle-vuln-detector>` for more details.

The following fields are captured in every alert:

- CVE: The Common Vulnerabilities and Exposures identifier for the corresponding vulnerability.
- Title: Short description of the impact of vulnerability.
- Severity: It specifies the impact of the vulnerability in terms of security.
- Published: Date when the vulnerability was included in the official database.
- Reference: URL of the official database website with extra information of the vulnerability.
- Rationale: Broad description of the vulnerability.
- State: This field informs if it exists a patch for the vulnerability (*fixed*) or instead, its state.
- CVSS: The Common Vulnerability Score System in version 2 and 3.
- Condition: Reason for report the vulnerability.
- CWE: The Common Weakness Enumeration reference.

See below for examples of alerts:

.. code-block:: console
    :emphasize-lines: 3,6

    ** Alert 1532935655.161547: - vulnerability-detector,gdpr_IV_35.7.d,
    2018 Jul 30 09:27:35 manager->vulnerability-detector
    Rule: 23505 (level 10) -> 'CVE-2018-3693 on Ubuntu 18.04 LTS (bionic) - high.'
    vulnerability.cve: CVE-2018-3693
    vulnerability.title: CVE-2018-3693 on Ubuntu 18.04 LTS (bionic) - high.
    vulnerability.severity: High
    vulnerability.published: 2018-07-10
    vulnerability.updated: 2018-07-10
    vulnerability.reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-3693
    vulnerability.state: Pending confirmation
    vulnerability.package.name: firefox
    vulnerability.package.version: 61.0.1+build1-0ubuntu0.18.04.1
    vulnerability.package.architecture: i686

.. code-block:: console
    :emphasize-lines: 3,5

    2019 Jan 09 08:55:36 (cent7) any->vulnerability-detector
    Rule: 23505 (level 10) -> 'policycoreutils: local privilege escalation via seunsharen via seunshare'
    vulnerability.cve: CVE-2014-3215
    vulnerability.title: policycoreutils: local privilege escalation via seunsharen via seunshare
    vulnerability.severity: important
    vulnerability.published: 2012-12-08T00:00:00+00:00
    vulnerability.state: Fixed
    vulnerability.cvss.cvss_score: 6.9
    vulnerability.cvss.cvss_scoring_vector: AV:L/AC:M/Au:N/C:C/I:C/A:C
    vulnerability.package.name: libcap-ng
    vulnerability.package.version: 0.7.5-4.el7
    vulnerability.package.architecture: i686
    vulnerability.condition: less than or equal 0.7.5-4.el7
    vulnerability.advisories: RHSA-2015:0864,RHBA-2015:2161
    vulnerability.cwe_reference: CWE-270
    vulnerability.bugzilla_reference: https://bugzilla.redhat.com/show_bug.cgi?id=1095855
    vulnerability.reference: https://access.redhat.com/security/cve/CVE-2014-3215


.. code-block:: console
    :emphasize-lines: 3,6

    ** Alert 1552410861.5364618: - vulnerability-detector,gdpr_IV_35.7.d,
    2019 Mar 12 17:14:21 (agwin-2016) 192.168.99.136->vulnerability-detector
    Rule: 23504 (level 7) -> 'Windows 7 SP1, Windows 8.1 and RT 8.1, Windows Server 2008 SP2 and R2 SP1, Windows Server 2012 and R2, Windows 10 Gold, 1511, 1607, 1703 and 1709, Windows Server 2016 and Windows Server, version 1709 allow a remote code execution vulnerability due to the way the Routing and Remote Access service handles requests, aka "Windows RRAS Service Remote Code Execution Vulnerability".'
    vulnerability.cve: CVE-2017-11885
    vulnerability.title: Windows 7 SP1, Windows 8.1 and RT 8.1, Windows Server 2008 SP2 and R2 SP1, Windows Server 2012 and R2, Windows 10 Gold, 1511, 1607, 1703 and 1709, Windows Server 2016 and Windows Server, version 1709 allow a remote code execution vulnerability due to the way the Routing and Remote Access service handles requests, aka "Windows RRAS Service Remote Code Execution Vulnerability".
    vulnerability.severity: Medium
    vulnerability.published: 2017-12-12T21:29Z
    vulnerability.updated: 2018-10-30T16:27Z
    vulnerability.state: Fixed
    vulnerability.cvss.cvss2.scoring_vector: AV:N/AC:M/Au:S/C:C/I:C/A:C
    vulnerability.cvss.cvss2.base_score: 8.500000
    vulnerability.cvss.cvss3.scoring_vector: AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H
    vulnerability.cvss.cvss3.base_score: 6.600000
    vulnerability.condition: 4053579 patch is not installed.
    vulnerability.cwe_reference: CWE-20
    vulnerability.reference: http://www.securityfocus.com/bid/102055


The following image shows a vulnerability alert on Kibana:

.. thumbnail:: ../../images/manual/vuln-detector.png
    :title: Vulnerability detector alert example
    :align: center
    :width: 100%
