.. Copyright (C) 2019 Wazuh, Inc.

.. _elastic_server_rpm:

Install Elastic Stack with RPM packages
=======================================

The RPM packages are suitable for installation on Red Hat, CentOS and other RPM-based systems.

.. note:: Many of the commands described below need to be executed with root user privileges.

Preparation
-----------

1. Install the Elastic repository and its GPG key:

  .. code-block:: console

    # rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch

    # cat > /etc/yum.repos.d/elastic.repo << EOF
    [elasticsearch-7.x]
    name=Elasticsearch repository for 7.x packages
    baseurl=https://artifacts.elastic.co/packages/7.x/yum
    gpgcheck=1
    gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
    enabled=1
    autorefresh=1
    type=rpm-md
    EOF

Elasticsearch
-------------

Elasticsearch is a highly scalable full-text search and analytics engine. For more information, please see `Elasticsearch <https://www.elastic.co/products/elasticsearch>`_.

1. Install the Elasticsearch package:

  .. code-block:: console

    # yum install elasticsearch-7.0.0

2. Enable and start the Elasticsearch service:

  a) For Systemd:

  .. code-block:: console

    # systemctl daemon-reload
    # systemctl enable elasticsearch.service
    # systemctl start elasticsearch.service

  b) For SysV Init:

  .. code-block:: console

    # chkconfig --add elasticsearch
    # service elasticsearch start

  It's important to wait until the Elasticsearch server finishes starting. Check the current status with the following command:

  .. code-block:: console

    # curl "http://localhost:9200"

3. Load the alerts template for Elasticsearch:

  .. code-block:: console

    # curl https://raw.githubusercontent.com/wazuh/wazuh/3.9/extensions/elasticsearch/wazuh-elastic7-template-alerts.json | curl -X PUT "http://localhost:9200/_template/wazuh" -H 'Content-Type: application/json' -d @-


.. _elastic_server_rpm_logstash:

Logstash
--------

Logstash is the tool that collects, parses, and forwards data to Elasticsearch for indexing and storage of all logs generated by the Wazuh server. For more information, please see `Logstash <https://www.elastic.co/products/logstash>`_.

1. Java 8 is required by Logstash.

  Install the Java 8 OpenJDK package using yum:

  .. code-block:: console

    # yum install java-1.8.0-openjdk

2. Install the Logstash package:

  .. code-block:: console

    # yum install logstash-7.0.0

3. Download the Wazuh configuration file for Logstash:

  - **Local** configuration (only in a **single-host architecture**):

    .. code-block:: console

      # curl -so /etc/logstash/conf.d/01-wazuh.conf https://raw.githubusercontent.com/wazuh/wazuh/3.9/extensions/logstash/01-wazuh-local-7.conf

    Because the Logstash user needs to read the alerts.json file, please add it to OSSEC group by running:

    .. code-block:: console

      # usermod -a -G ossec logstash

  - **Remote** configuration (only in a **distributed architecture**):

    .. code-block:: console

      # curl -so /etc/logstash/conf.d/01-wazuh.conf https://raw.githubusercontent.com/wazuh/wazuh/3.9/extensions/logstash/01-wazuh-remote-7.conf


.. note::

    Follow the next steps if you use CentOS-6/RHEL-6 or Amazon AMI (logstash uses Upstart like a service manager and needs to be fixed, see `this bug <https://bugs.launchpad.net/upstart/+bug/812870/>`_):

    1) Edit the file /etc/logstash/startup.options changing line 30 from *LS_GROUP=logstash* to *LS_GROUP=ossec*.
    2) Update the service with the new parameters by running the command /usr/share/logstash/bin/system-install
    3) Restart Logstash.

3. Enable and start the Logstash service:

  a) For Systemd:

  .. code-block:: console

    # systemctl daemon-reload
    # systemctl enable logstash.service
    # systemctl start logstash.service

  b) For SysV Init:

  .. code-block:: console

    # chkconfig --add logstash
    # service logstash start

.. _install_kibana_app_rpm:

Kibana
------

Kibana is a flexible and intuitive web interface for mining and visualizing the events and archives stored in Elasticsearch. Find more information at `Kibana <https://www.elastic.co/products/kibana>`_.

1. Install the Kibana package:

  .. code-block:: console

    # yum install kibana-7.0.0

2. Install the Wazuh app plugin for Kibana:

  a) With sudo:

  .. code-block:: console

    # sudo -u kibana /usr/share/kibana/bin/kibana-plugin install https://packages.wazuh.com/wazuhapp/wazuhapp-3.9.0_7.0.0.zip

  b) Without sudo:

  .. code-block:: console

    # su -c '/usr/share/kibana/bin/kibana-plugin install https://packages.wazuh.com/wazuhapp/wazuhapp-3.9.0_7.0.0.zip' kibana

3. **Optional.** Kibana will only listen on the loopback interface (localhost) by default. To set up Kibana to listen on all interfaces, edit the file ``/etc/kibana/kibana.yml`` uncommenting the setting ``server.host``. Change the value to:

  .. code-block:: yaml

    server.host: "0.0.0.0"

4. Enable and start the Kibana service:

  a) For Systemd:

  .. code-block:: console

    # systemctl daemon-reload
    # systemctl enable kibana.service
    # systemctl start kibana.service

  b) For SysV Init:

  .. code-block:: console

    # chkconfig --add kibana
    # service kibana start

5. (Optional) Disable the Elasticsearch repository:

  It is recommended that the Elasticsearch repository be disabled in order to prevent an upgrade to a newer Elastic Stack version due to the possibility of undoing changes with the App. To do this, use the following command:

  .. code-block:: console

    # sed -i "s/^enabled=1/enabled=0/" /etc/yum.repos.d/elastic.repo

Next steps
----------

Once the Wazuh and Elastic Stack servers are installed and connected, you can install and connect Wazuh agents. Follow :ref:`this guide <installation_agents>` and read the instructions for your specific environment.

You can also read the Kibana app :ref:`user manual <kibana_app>` to learn more about its features and how to use it.
