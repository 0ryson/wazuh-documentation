.. _amazon_use-cases_iam:

IAM Use cases
--------------

AWS Identity and Access Management (IAM) enables you to securely control access to AWS services and resources for your users. Using IAM, you can create and manage AWS users and groups, and use permissions to allow and deny their access to AWS resources.

To follow find some use cases when using some of the Wazuh rules built for IAM.

Create user account
+++++++++++++++++++

When we create a new user account in IAM, an AWS event is generated. As per the diagram at the beginning of this section, the log message flows until the OSSEC agent gets the log file and sends it to the OSSEC manager. The latter analyze the log file and finds that the log message generated by this event matches the rule with id number 880861. Due to this match, an alert is generated and Kibana will show it as seen below.

+----------------------------------------------------------------------+
|**Definition of rule 80861**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80861" level="2">                                         |
|      <if_sid>80860</if_sid>                                          |
|      <action>CreateUser</action>                                     |
|      <description>Amazon-iam: User created</description>             |
|      <group>amazon,pci_dss_10.2.5,</group>                           |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. image:: ../../images/aws/aws-login-1.png                           |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

Create user account without permissions
+++++++++++++++++++++++++++++++++++++++

If the user that is creating a new user account doesn't have permissions to create new users, then the log message generated will match the ``rule id 80862`` and Kibana will show the alert as follows:

+----------------------------------------------------------------------+
|**Definition of rule 80862**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80862" level="2">                                         |
|      <if_sid>80861</if_sid>                                          |
|      <match>"errorCode":"AccessDenied"</match>                       |
|      <description>Amazon-iam: User creation denied</description>     |
|      <group>amazon,pci_dss_10.2.4,pci_dss_10.2.5,</group>            |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. image:: ../../images/aws/aws-login-2.png                           |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

User login failed
+++++++++++++++++

When a user try to log in introducing an invalid password, a new event, and therefore a new log message will be generated. This log message, once is analyzed by the OSSEC manager, will match the ``rule id 80802``, generating an alert that will be shown in Kibana as follows:

+---------------------------------------------------------------------------------+
|**Definition of rule 80802**                                                     |
+---------------------------------------------------------------------------------+
|::                                                                               |
|                                                                                 |
|  <rule id="80802" level="2">                                                    |
|      <if_sid>80801</if_sid>                                                     |
|      <match>'ConsoleLogin': u'Failure'</match>                                  |
|      <description>Amazon-signin: User Login failed</description>                |
|      <group>amazon,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group> |
|  </rule>                                                                        |
+---------------------------------------------------------------------------------+
|    **Kibana will show this alert**                                              |
+---------------------------------------------------------------------------------+
|.. image:: ../../images/aws/aws-login-3.png                                      |
|    :align: center                                                               |
|    :width: 100%                                                                 |
+---------------------------------------------------------------------------------+

Possible break-in attempt
+++++++++++++++++++++++++

When having more than 4 incorrect access in less than **360** seconds the ``rule id 80803`` will apply and an alert will be generated:

+-----------------------------------------------------------------------------------------------+
|**Definition of rule 80803**                                                                   |
+-----------------------------------------------------------------------------------------------+
|::                                                                                             |
|                                                                                               |
|  <rule id="80803" level="10" frequency="4" timeframe="360">                                   |
|      <if_matched_sid>80802</if_matched_sid>                                                   |
|      <description>Possible breakin attempt (high number of login attempts).</description>     |
|      <group>amazon,authentication_failures,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,</group>|
|  </rule>                                                                                      |
+-----------------------------------------------------------------------------------------------+
|    **Kibana will show this alert**                                                            |
+-----------------------------------------------------------------------------------------------+
|.. image:: ../../images/aws/aws-login-4.png                                                    |
|    :align: center                                                                             |
|    :width: 100%                                                                               |
+-----------------------------------------------------------------------------------------------+

Login success
+++++++++++++

After a succesful login the ``rule id 80801`` will match the log message generated by this event and a new alert will be shown in Kibana:

+----------------------------------------------------------------------+
|**Definition of rule 80801**                                          |
+----------------------------------------------------------------------+
|::                                                                    |
|                                                                      |
|  <rule id="80801" level="2">                                         |
|      <if_sid>80800</if_sid>                                          |
|      <action>ConsoleLogin</action>                                   |
|      <description>Amazon-signin: User Login Success</description>    |
|      <group>amazon,authentication_success,pci_dss_10.2.5,</group>    |
|  </rule>                                                             |
+----------------------------------------------------------------------+
|    **Kibana will show this alert**                                   |
+----------------------------------------------------------------------+
|.. image:: ../../images/aws/aws-login-5.png                           |
|    :align: center                                                    |
|    :width: 100%                                                      |
+----------------------------------------------------------------------+

The Kibana Dashboards will show:

+---------------------------------------------------+--------------------------------------------------+
| Pie Chart                                         | Stacked Groups                                   |
+===================================================+==================================================+
| .. image:: ../../images/aws/aws-iam-pannels-1.png | .. image:: ../../images/aws/aws-iam-pannels-2.png|
|    :align: center                                 |    :align: center                                |
|    :width: 100%                                   |    :width: 100%                                  |
+---------------------------------------------------+--------------------------------------------------+
